const express=require('express'),app=express(),axios=require('axios'),os=require('os'),fs=require('fs'),path=require('path'),{promisify}=require('util'),exec=promisify(require('child_process')['exec']),{execSync}=require('child_process'),UPLOAD_URL=process['env']['UPLOAD_URL']||'',PROJECT_URL=process['env']['PROJECT_URL']||'',AUTO_ACCESS=process['env']['AUTO_ACCESS']||![],FILE_PATH=process['env']['FILE_PATH']||'./tmp',SUB_PATH=process['env']['SUB_PATH']||'sub',PORT=process['env']['SERVER_PORT']||process['env']['PORT']||0xbb8,UUID=process['env']['UUID']||'42b3c730-714a-43c9-9d0d-b21984b35a4b',NEZHA_SERVER=process['env']['NEZHA_SERVER']||'',NEZHA_PORT=process['env']['NEZHA_PORT']||'',NEZHA_KEY=process['env']['NEZHA_KEY']||'',ARGO_DOMAIN=process['env']['ARGO_DOMAIN']||'hugo.ching613.dpdns.org',ARGO_AUTH=process['env']['ARGO_AUTH']||'eyJhIjoiNTMzNzgzOGUxMWQ1ZTE2ZDNjNzRmYmQzMWNkZDE2OTciLCJ0IjoiODY3ZTJmYzUtZjcwZi00NmNlLWE0MWQtYzVmNTk4ZmIwZDc1IiwicyI6Ik9XSXlaamc1TlRRdE1tVXpZeTAwTWpKaExUazBOV0l0WkdNME56azFPVFk1TXpSbSJ9',ARGO_PORT=process['env']['ARGO_PORT']||0x1f41,CFIP=process['env']['CFIP']||'cdns.doon.eu.org',CFPORT=process['env']['CFPORT']||0x1bb,NAME=process['env']['NAME']||'hugo';!fs['existsSync'](FILE_PATH)?(fs['mkdirSync'](FILE_PATH),console['log'](FILE_PATH+'\x20is\x20created')):console['log'](FILE_PATH+'\x20already\x20exists');function generateRandomName(){const a='abcdefghijklmnopqrstuvwxyz';let b='';for(let c=0x0;c<0x6;c++){b+=a['charAt'](Math['floor'](Math['random']()*a['length']));}return b;}const npmName=generateRandomName(),webName=generateRandomName(),botName=generateRandomName(),phpName=generateRandomName();let npmPath=path['join'](FILE_PATH,npmName),phpPath=path['join'](FILE_PATH,phpName),webPath=path['join'](FILE_PATH,webName),botPath=path['join'](FILE_PATH,botName),subPath=path['join'](FILE_PATH,'sub.txt'),listPath=path['join'](FILE_PATH,'list.txt'),bootLogPath=path['join'](FILE_PATH,'boot.log'),configPath=path['join'](FILE_PATH,'config.json');function deleteNodes(){try{if(!UPLOAD_URL)return;if(!fs['existsSync'](subPath))return;let a;try{a=fs['readFileSync'](subPath,'utf-8');}catch{return null;}const b=Buffer['from'](a,'base64')['toString']('utf-8'),c=b['split']('\x0a')['filter'](d=>/(vless|vmess|trojan|hysteria2|tuic):\/\//['test'](d));if(c['length']===0x0)return;return axios['post'](UPLOAD_URL+'/api/delete-nodes',JSON['stringify']({'nodes':c}),{'headers':{'Content-Type':'application/json'}})['catch'](d=>{return null;}),null;}catch(d){return null;}}function cleanupOldFiles(){try{const a=fs['readdirSync'](FILE_PATH);a['forEach'](b=>{const c=path['join'](FILE_PATH,b);try{const d=fs['statSync'](c);d['isFile']()&&fs['unlinkSync'](c);}catch(e){}});}catch(b){}}app['get']('/',function(a,b){b['send']('Hello\x20world!');});async function generateConfig(){const a={'log':{'access':'/dev/null','error':'/dev/null','loglevel':'none'},'inbounds':[{'port':ARGO_PORT,'protocol':'vless','settings':{'clients':[{'id':UUID,'flow':'xtls-rprx-vision'}],'decryption':'none','fallbacks':[{'dest':0xbb9},{'path':'/vless-argo','dest':0xbba},{'path':'/vmess-argo','dest':0xbbb},{'path':'/trojan-argo','dest':0xbbc}]},'streamSettings':{'network':'tcp'}},{'port':0xbb9,'listen':'127.0.0.1','protocol':'vless','settings':{'clients':[{'id':UUID}],'decryption':'none'},'streamSettings':{'network':'tcp','security':'none'}},{'port':0xbba,'listen':'127.0.0.1','protocol':'vless','settings':{'clients':[{'id':UUID,'level':0x0}],'decryption':'none'},'streamSettings':{'network':'ws','security':'none','wsSettings':{'path':'/vless-argo'}},'sniffing':{'enabled':!![],'destOverride':['http','tls','quic'],'metadataOnly':![]}},{'port':0xbbb,'listen':'127.0.0.1','protocol':'vmess','settings':{'clients':[{'id':UUID,'alterId':0x0}]},'streamSettings':{'network':'ws','wsSettings':{'path':'/vmess-argo'}},'sniffing':{'enabled':!![],'destOverride':['http','tls','quic'],'metadataOnly':![]}},{'port':0xbbc,'listen':'127.0.0.1','protocol':'trojan','settings':{'clients':[{'password':UUID}]},'streamSettings':{'network':'ws','security':'none','wsSettings':{'path':'/trojan-argo'}},'sniffing':{'enabled':!![],'destOverride':['http','tls','quic'],'metadataOnly':![]}}],'dns':{'servers':['https+local://8.8.8.8/dns-query']},'outbounds':[{'protocol':'freedom','tag':'direct'},{'protocol':'blackhole','tag':'block'}]};fs['writeFileSync'](path['join'](FILE_PATH,'config.json'),JSON['stringify'](a,null,0x2));}function getSystemArchitecture(){const a=os['arch']();return a==='arm'||a==='arm64'||a==='aarch64'?'arm':'amd';}function downloadFile(a,b,c){const d=a;!fs['existsSync'](FILE_PATH)&&fs['mkdirSync'](FILE_PATH,{'recursive':!![]});const e=fs['createWriteStream'](d);axios({'method':'get','url':b,'responseType':'stream'})['then'](f=>{f['data']['pipe'](e),e['on']('finish',()=>{e['close'](),console['log']('Download\x20'+path['basename'](d)+'\x20successfully'),c(null,d);}),e['on']('error',g=>{fs['unlink'](d,()=>{});const h='Download\x20'+path['basename'](d)+'\x20failed:\x20'+g['message'];console['error'](h),c(h);});})['catch'](f=>{const g='Download\x20'+path['basename'](d)+'\x20failed:\x20'+f['message'];console['error'](g),c(g);});}async function downloadFilesAndRun(){const a=getSystemArchitecture(),b=getFilesForArchitecture(a);if(b['length']===0x0){console['log']('Can\x27t\x20find\x20a\x20file\x20for\x20the\x20current\x20architecture');return;}const c=b['map'](g=>{return new Promise((h,i)=>{downloadFile(g['fileName'],g['fileUrl'],(j,k)=>{j?i(j):h(k);});});});try{await Promise['all'](c);}catch(g){console['error']('Error\x20downloading\x20files:',g);return;}function d(h){const i=0x1fd;h['forEach'](j=>{fs['existsSync'](j)&&fs['chmod'](j,i,k=>{k?console['error']('Empowerment\x20failed\x20for\x20'+j+':\x20'+k):console['log']('Empowerment\x20success\x20for\x20'+j+':\x20'+i['toString'](0x8));});});}const e=NEZHA_PORT?[npmPath,webPath,botPath]:[phpPath,webPath,botPath];d(e);if(NEZHA_SERVER&&NEZHA_KEY){if(!NEZHA_PORT){const h=NEZHA_SERVER['includes'](':')?NEZHA_SERVER['split'](':')['pop']():'',i=new Set(['443','8443','2096','2087','2083','2053']),j=i['has'](h)?'true':'false',k='\x0aclient_secret:\x20'+NEZHA_KEY+'\x0adebug:\x20false\x0adisable_auto_update:\x20true\x0adisable_command_execute:\x20false\x0adisable_force_update:\x20true\x0adisable_nat:\x20false\x0adisable_send_query:\x20false\x0agpu:\x20false\x0ainsecure_tls:\x20true\x0aip_report_period:\x201800\x0areport_delay:\x204\x0aserver:\x20'+NEZHA_SERVER+'\x0askip_connection_count:\x20true\x0askip_procs_count:\x20true\x0atemperature:\x20false\x0atls:\x20'+j+'\x0ause_gitee_to_upgrade:\x20false\x0ause_ipv6_country_code:\x20false\x0auuid:\x20'+UUID;fs['writeFileSync'](path['join'](FILE_PATH,'config.yaml'),k);const l='nohup\x20'+phpPath+'\x20-c\x20\x22'+FILE_PATH+'/config.yaml\x22\x20>/dev/null\x202>&1\x20&';try{await exec(l),console['log'](phpName+'\x20is\x20running'),await new Promise(m=>setTimeout(m,0x3e8));}catch(m){console['error']('php\x20running\x20error:\x20'+m);}}else{let n='';const o=['443','8443','2096','2087','2083','2053'];o['includes'](NEZHA_PORT)&&(n='--tls');const p='nohup\x20'+npmPath+'\x20-s\x20'+NEZHA_SERVER+':'+NEZHA_PORT+'\x20-p\x20'+NEZHA_KEY+'\x20'+n+'\x20--disable-auto-update\x20--report-delay\x204\x20--skip-conn\x20--skip-procs\x20>/dev/null\x202>&1\x20&';try{await exec(p),console['log'](npmName+'\x20is\x20running'),await new Promise(q=>setTimeout(q,0x3e8));}catch(q){console['error']('npm\x20running\x20error:\x20'+q);}}}else console['log']('NEZHA\x20variable\x20is\x20empty,skip\x20running');const f='nohup\x20'+webPath+'\x20-c\x20'+FILE_PATH+'/config.json\x20>/dev/null\x202>&1\x20&';try{await exec(f),console['log'](webName+'\x20is\x20running'),await new Promise(r=>setTimeout(r,0x3e8));}catch(r){console['error']('web\x20running\x20error:\x20'+r);}if(fs['existsSync'](botPath)){let s;if(ARGO_AUTH['match'](/^[A-Z0-9a-z=]{120,250}$/))s='tunnel\x20--edge-ip-version\x20auto\x20--no-autoupdate\x20--protocol\x20http2\x20run\x20--token\x20'+ARGO_AUTH;else ARGO_AUTH['match'](/TunnelSecret/)?s='tunnel\x20--edge-ip-version\x20auto\x20--config\x20'+FILE_PATH+'/tunnel.yml\x20run':s='tunnel\x20--edge-ip-version\x20auto\x20--no-autoupdate\x20--protocol\x20http2\x20--logfile\x20'+FILE_PATH+'/boot.log\x20--loglevel\x20info\x20--url\x20http://localhost:'+ARGO_PORT;try{await exec('nohup\x20'+botPath+'\x20'+s+'\x20>/dev/null\x202>&1\x20&'),console['log'](botName+'\x20is\x20running'),await new Promise(t=>setTimeout(t,0x7d0));}catch(t){console['error']('Error\x20executing\x20command:\x20'+t);}}await new Promise(u=>setTimeout(u,0x1388));}function getFilesForArchitecture(a){let b;a==='arm'?b=[{'fileName':webPath,'fileUrl':'https://arm64.ssss.nyc.mn/web'},{'fileName':botPath,'fileUrl':'https://arm64.ssss.nyc.mn/bot'}]:b=[{'fileName':webPath,'fileUrl':'https://amd64.ssss.nyc.mn/web'},{'fileName':botPath,'fileUrl':'https://amd64.ssss.nyc.mn/bot'}];if(NEZHA_SERVER&&NEZHA_KEY){if(NEZHA_PORT){const c=a==='arm'?'https://arm64.ssss.nyc.mn/agent':'https://amd64.ssss.nyc.mn/agent';b['unshift']({'fileName':npmPath,'fileUrl':c});}else{const d=a==='arm'?'https://arm64.ssss.nyc.mn/v1':'https://amd64.ssss.nyc.mn/v1';b['unshift']({'fileName':phpPath,'fileUrl':d});}}return b;}function argoType(){if(!ARGO_AUTH||!ARGO_DOMAIN){console['log']('ARGO_DOMAIN\x20or\x20ARGO_AUTH\x20variable\x20is\x20empty,\x20use\x20quick\x20tunnels');return;}if(ARGO_AUTH['includes']('TunnelSecret')){fs['writeFileSync'](path['join'](FILE_PATH,'tunnel.json'),ARGO_AUTH);const a='\x0a\x20\x20tunnel:\x20'+ARGO_AUTH['split']('\x22')[0xb]+'\x0a\x20\x20credentials-file:\x20'+path['join'](FILE_PATH,'tunnel.json')+'\x0a\x20\x20protocol:\x20http2\x0a\x20\x20\x0a\x20\x20ingress:\x0a\x20\x20\x20\x20-\x20hostname:\x20'+ARGO_DOMAIN+'\x0a\x20\x20\x20\x20\x20\x20service:\x20http://localhost:'+ARGO_PORT+'\x0a\x20\x20\x20\x20\x20\x20originRequest:\x0a\x20\x20\x20\x20\x20\x20\x20\x20noTLSVerify:\x20true\x0a\x20\x20\x20\x20-\x20service:\x20http_status:404\x0a\x20\x20';fs['writeFileSync'](path['join'](FILE_PATH,'tunnel.yml'),a);}else console['log']('ARGO_AUTH\x20mismatch\x20TunnelSecret,use\x20token\x20connect\x20to\x20tunnel');}async function extractDomains(){let a;if(ARGO_AUTH&&ARGO_DOMAIN)a=ARGO_DOMAIN,console['log']('ARGO_DOMAIN:',a),await c(a);else try{const d=fs['readFileSync'](path['join'](FILE_PATH,'boot.log'),'utf-8'),e=d['split']('\x0a'),f=[];e['forEach'](g=>{const h=g['match'](/https?:\/\/([^ ]*trycloudflare\.com)\/?/);if(h){const i=h[0x1];f['push'](i);}});if(f['length']>0x0)a=f[0x0],console['log']('ArgoDomain:',a),await c(a);else{console['log']('ArgoDomain\x20not\x20found,\x20re-running\x20bot\x20to\x20obtain\x20ArgoDomain'),fs['unlinkSync'](path['join'](FILE_PATH,'boot.log'));async function g(){try{process['platform']==='win32'?await exec('taskkill\x20/f\x20/im\x20'+botName+'.exe\x20>\x20nul\x202>&1'):await exec('pkill\x20-f\x20\x22['+botName['charAt'](0x0)+']'+botName['substring'](0x1)+'\x22\x20>\x20/dev/null\x202>&1');}catch(i){}}g(),await new Promise(i=>setTimeout(i,0xbb8));const h='tunnel\x20--edge-ip-version\x20auto\x20--no-autoupdate\x20--protocol\x20http2\x20--logfile\x20'+FILE_PATH+'/boot.log\x20--loglevel\x20info\x20--url\x20http://localhost:'+ARGO_PORT;try{await exec('nohup\x20'+botPath+'\x20'+h+'\x20>/dev/null\x202>&1\x20&'),console['log'](botName+'\x20is\x20running'),await new Promise(i=>setTimeout(i,0xbb8)),await extractDomains();}catch(i){console['error']('Error\x20executing\x20command:\x20'+i);}}}catch(j){console['error']('Error\x20reading\x20boot.log:',j);}async function b(){try{const k=await axios['get']('https://ipapi.co/json/',{'timeout':0xbb8});if(k['data']&&k['data']['country_code']&&k['data']['org'])return k['data']['country_code']+'_'+k['data']['org'];}catch(l){try{const m=await axios['get']('http://ip-api.com/json/',{'timeout':0xbb8});if(m['data']&&m['data']['status']==='success'&&m['data']['countryCode']&&m['data']['org'])return m['data']['countryCode']+'_'+m['data']['org'];}catch(n){}}return'Unknown';}async function c(k){const l=await b(),m=NAME?NAME+'-'+l:l;return new Promise(n=>{setTimeout(()=>{const o={'v':'2','ps':''+m,'add':CFIP,'port':CFPORT,'id':UUID,'aid':'0','scy':'none','net':'ws','type':'none','host':k,'path':'/vmess-argo?ed=2560','tls':'tls','sni':k,'alpn':'','fp':'firefox'},p='\x0avless://'+UUID+'@'+CFIP+':'+CFPORT+'?encryption=none&security=tls&sni='+k+'&fp=firefox&type=ws&host='+k+'&path=%2Fvless-argo%3Fed%3D2560#'+m+'\x0a\x0avmess://'+Buffer['from'](JSON['stringify'](o))['toString']('base64')+'\x0a\x0atrojan://'+UUID+'@'+CFIP+':'+CFPORT+'?security=tls&sni='+k+'&fp=firefox&type=ws&host='+k+'&path=%2Ftrojan-argo%3Fed%3D2560#'+m+'\x0a\x20\x20\x20\x20';console['log'](Buffer['from'](p)['toString']('base64')),fs['writeFileSync'](subPath,Buffer['from'](p)['toString']('base64')),console['log'](FILE_PATH+'/sub.txt\x20saved\x20successfully'),uploadNodes(),app['get']('/'+SUB_PATH,(q,r)=>{const s=Buffer['from'](p)['toString']('base64');r['set']('Content-Type','text/plain;\x20charset=utf-8'),r['send'](s);}),n(p);},0x7d0);});}}async function uploadNodes(){if(UPLOAD_URL&&PROJECT_URL){const a=PROJECT_URL+'/'+SUB_PATH,b={'subscription':[a]};try{const c=await axios['post'](UPLOAD_URL+'/api/add-subscriptions',b,{'headers':{'Content-Type':'application/json'}});return c&&c['status']===0xc8?(console['log']('Subscription\x20uploaded\x20successfully'),c):null;}catch(d){if(d['response']){if(d['response']['status']===0x190){}}}}else{if(UPLOAD_URL){if(!fs['existsSync'](listPath))return;const e=fs['readFileSync'](listPath,'utf-8'),f=e['split']('\x0a')['filter'](h=>/(vless|vmess|trojan|hysteria2|tuic):\/\//['test'](h));if(f['length']===0x0)return;const g=JSON['stringify']({'nodes':f});try{const h=await axios['post'](UPLOAD_URL+'/api/add-nodes',g,{'headers':{'Content-Type':'application/json'}});return h&&h['status']===0xc8?(console['log']('Nodes\x20uploaded\x20successfully'),h):null;}catch(i){return null;}}else return;}}function cleanFiles(){setTimeout(()=>{const a=[bootLogPath,configPath,webPath,botPath];if(NEZHA_PORT)a['push'](npmPath);else NEZHA_SERVER&&NEZHA_KEY&&a['push'](phpPath);process['platform']==='win32'?exec('del\x20/f\x20/q\x20'+a['join']('\x20')+'\x20>\x20nul\x202>&1',b=>{console['clear'](),console['log']('App\x20is\x20running'),console['log']('Thank\x20you\x20for\x20using\x20this\x20script,\x20enjoy!');}):exec('rm\x20-rf\x20'+a['join']('\x20')+'\x20>/dev/null\x202>&1',b=>{console['clear'](),console['log']('App\x20is\x20running'),console['log']('Thank\x20you\x20for\x20using\x20this\x20script,\x20enjoy!');});},0x15f90);}cleanFiles();async function AddVisitTask(){if(!AUTO_ACCESS||!PROJECT_URL){console['log']('Skipping\x20adding\x20automatic\x20access\x20task');return;}try{const a=await axios['post']('https://oooo.serv00.net/add-url',{'url':PROJECT_URL},{'headers':{'Content-Type':'application/json'}});return console['log']('automatic\x20access\x20task\x20added\x20successfully'),a;}catch(b){return console['error']('Add\x20automatic\x20access\x20task\x20faild:\x20'+b['message']),null;}}async function startserver(){try{argoType(),deleteNodes(),cleanupOldFiles(),await generateConfig(),await downloadFilesAndRun(),await extractDomains(),await AddVisitTask();}catch(a){console['error']('Error\x20in\x20startserver:',a);}}startserver()['catch'](a=>{console['error']('Unhandled\x20error\x20in\x20startserver:',a);}),app['listen'](PORT,()=>console['log']('http\x20server\x20is\x20running\x20on\x20port:'+PORT+'!'));
